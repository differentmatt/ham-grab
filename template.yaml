AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Movie Night Vote - Ranked Choice Voting

Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    MemorySize: 256
    Environment:
      Variables:
        POLLS_TABLE: !Ref PollsTable
        ANTHROPIC_API_KEY: !Ref AnthropicApiKey
    Architectures:
      - arm64

  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type'"
      AllowOrigin: "'*'"

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod

  DomainName:
    Type: String
    Default: ""
    Description: Custom domain name (optional, leave empty to use CloudFront URL)

  AnthropicApiKey:
    Type: String
    Default: ""
    Description: Anthropic API key for movie descriptions (optional)
    NoEcho: true

Conditions:
  HasCustomDomain: !Not [!Equals [!Ref DomainName, ""]]
  IsProd: !Equals [!Ref Stage, "prod"]

Resources:
  # ============ DATABASE ============
  PollsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub movie-vote-polls-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true

  # ============ API ============
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      Auth:
        DefaultAuthorizer: NONE

  # ============ FRONTEND HOSTING ============
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub movie-vote-frontend-${Stage}-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub ${FrontendBucket.Arn}/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}

  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub movie-vote-oac-${Stage}
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        HttpVersion: http2and3
        PriceClass: PriceClass_100

        Aliases: !If
          - IsProd
          - - hamgrab.com
            - www.hamgrab.com
          - !Ref AWS::NoValue

        ViewerCertificate: !If
          - IsProd
          - AcmCertificateArn: arn:aws:acm:us-east-1:886118263343:certificate/f0600e73-0f55-49ec-93fd-d9b3b92a2f80
            SslSupportMethod: sni-only
            MinimumProtocolVersion: TLSv1.2_2021
          - CloudFrontDefaultCertificate: true

        Origins:
          # S3 origin for frontend
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            OriginAccessControlId: !Ref CloudFrontOriginAccessControl
            S3OriginConfig:
              OriginAccessIdentity: ""

          # API Gateway origin
          - Id: ApiOrigin
            DomainName: !Sub ${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com
            CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
            OriginPath: !Sub /${Stage}

        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          Compress: true

        CacheBehaviors:
          # API requests bypass cache
          - PathPattern: /polls*
            TargetOriginId: ApiOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
              - PUT
              - POST
              - PATCH
              - DELETE
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingDisabled
            OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac  # AllViewerExceptHostHeader

        # SPA routing - serve index.html for 404s
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html

  # Lambda Functions
  CreatePollFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/polls.create
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  GetPollFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/polls.get
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/{pollId}
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  GetPollStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/polls.getStats
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/stats
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  UpdatePollPhaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/polls.updatePhase
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/{pollId}/phase
            Method: PUT
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  AddMovieFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/movies.add
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/{pollId}/movies
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  RemoveMovieFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/movies.remove
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/{pollId}/movies/{movieId}
            Method: DELETE
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

  SubmitVoteFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: handlers/votes.submit
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /polls/{pollId}/votes
            Method: POST
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PollsTable

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"

  FrontendUrl:
    Description: CloudFront URL for the frontend
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"

  FrontendBucket:
    Description: S3 bucket for frontend deployment
    Value: !Ref FrontendBucket

  CloudFrontDistributionId:
    Description: CloudFront distribution ID (for cache invalidation)
    Value: !Ref CloudFrontDistribution

  PollsTableName:
    Description: DynamoDB table name
    Value: !Ref PollsTable
